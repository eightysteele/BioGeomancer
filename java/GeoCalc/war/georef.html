<!DOCTYPE html> 
<html> 
<head> 
<meta name="viewport" content="initial-scale=1.0, user-scalable=no"/> 
<meta http-equiv="content-type" content="text/html; charset=UTF-8"/> 
<title>Georeference - Feature Only</title> 
<link href="http://code.google.com/apis/maps/documentation/javascript/examples/standard.css" rel="stylesheet" type="text/css" /> 
<link href='http://fonts.googleapis.com/css?family=Gruppo' rel='stylesheet' type='text/css'>
<style>
#bg {
  font-family: 'Gruppo', serif;
  font-size: 26px;
  font-style: normal;
  font-weight: 400;
  text-shadow: none;
  text-decoration: none;
  text-transform: none;
  letter-spacing: 0em;
  word-spacing: 0em;
  color: grey;
  line-height: 1.2;
}

#button {
    position:fixed;
    top:31px;
}

#clearMapButton {
    position:fixed;
    top:31px;
    left:400px;
}

</style>
<script src="http://maps.google.com/maps/api/js?sensor=false"></script>
<script src="http://maps.google.com/maps/api/js?libraries=geometry&sensor=false"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.4.4/jquery.min.js"></script> 
</head> 
<body style="font: 75% Lucida Grande, Trebuchet MS"> 
    <div id='bg'>BioGeomancer2.0</div>
    <input id="location" type="search" style="width: 300px;"> 
    <input id="button" type="button" value="Georeference">
    <input id="clearMapButton" type="button" value="Clear Map">
    <p> 
    <div id="map_canvas" style="height:60%"></div>
    <p>    
    <div id="geoCalcUrl"></div>
    <p>
    <div id="json_results"></div>
<script><!-- 

	$ = (function () {
  		var $ = function(id) {
    		return document.getElementById(id);
  		}
  		return $;
	}());
	
	var app = app || {};
    
	app.handleOnClick = function(evt) {
    	var address = $('location').value;
    	if (address == '') {
    	  address = $('location').getAttribute('placeholder');
    	}
 		app.geocoder.geocode( { 'address': address}, function(results, status) {
    		if (status == google.maps.GeocoderStatus.OK) {
    			var position = results[0].geometry.location,
    			    viewport = results[0].geometry.viewport,
        		    bounds = results[0].geometry.bounds,
        		    center = null, 
        		    extent = null;
        		if (bounds != null) {
    			    center = bounds.getCenter();
    			    var sw = results[0].geometry.bounds.getSouthWest();
                    extent = google.maps.geometry.spherical.computeDistanceBetween(center, sw);    
        		} else {
            		center = position;
            		extent = 1000; // 1Km. Correct default extent?
        		}
      			var marker = new google.maps.Marker({
          			map: app.map, 
          			position: center
      			});      			

      			// Calculate geocoding uncertainty:
      		    var geoCalcUrl = '/geocalc?type=pno&extent='+extent+'&ll='+center.lat()+','+center.lng()+'&sys=dms&datum=not_recorded&source=gazetteer';
      		    var innerHTML = 'GeoCalc URL';
      		    innerHTML += ' (<a href="http://dev.biogeomancer.appspot.com' + geoCalcUrl + '">dev</a>, ';
      		    innerHTML += ' <a href="http://localhost:8080' + geoCalcUrl + '">local</a>): ';
      		    innerHTML += geoCalcUrl;
      			$('geoCalcUrl').innerHTML = innerHTML;
      			jQuery.ajax({
      			  url: geoCalcUrl, 
      			  success: function(data) {

                    // Circle:
      			    var point = new google.maps.LatLng(data.point.latitude, data.point.longitude);
      			    var opts = {
      			        center : point,
      			        radius : data.radius,
      			        fillColor: '#CEE3F6',
      			        strokeWeight: 1
      			    };
      			    var circle = new google.maps.Circle(opts);
      			    circle.setMap(app.map);      			          			    
      			    app.map.setCenter(point);      			

      			    // Bounding box:
      			    if (bounds != null) {
      			        var rectangle = new google.maps.Rectangle({bounds : bounds, strokeWeight : 1});
      			        //rectangle.setMap(app.map);
      			    }

      			   app.map.panToBounds(viewport);               
      			   app.map.setZoom(9);       
      			    
      			  }      			
      			});
    		  	$('json_results').innerHTML = 'Raw JSON results: ' + JSON.stringify(results);
      			
    		} else {
      			alert("Geocode was not successful for the following reason: " + status);
    		}
  		});
	}

    app.handleClearMap = function(evt) {
    	app.map = new google.maps.Map(document.getElementById("map_canvas"), app.mapOptions);
    	$('geoCalcUrl').innerHTML = '';
    	$('json_results').innerHTML = '';
    	$('location').value = '';
    }
        
	app.init = function() {
		var queryPlaceholder = "Berkeley, CA",			
    		latlng = new google.maps.LatLng(37.8, -121);
    		app.mapOptions = {
      			zoom: 8,
      			center: latlng,
      			mapTypeId: google.maps.MapTypeId.TERRAIN
    		};
    		
    	app.geocoder = new google.maps.Geocoder();
    	app.map = new google.maps.Map(document.getElementById("map_canvas"), app.mapOptions);
    	
    	$('button').addEventListener('click', app.handleOnClick, false);
    	$('clearMapButton').addEventListener('click', app.handleClearMap, false);
    	$('location').setAttribute('placeholder', queryPlaceholder);
		$('location').addEventListener('keyup', function(evt) {
  		if (evt.keyCode === 13) {
    		$('button').click();
 	 	}
		}, false);
	}
  	
	app.init();
	
--></script> 
</body> 
</html> 