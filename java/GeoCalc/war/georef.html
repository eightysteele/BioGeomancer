<!DOCTYPE html> 
<html> 
<head> 
<meta name="viewport" content="initial-scale=1.0, user-scalable=no"/> 
<meta http-equiv="content-type" content="text/html; charset=UTF-8"/> 
<title>BioGeomancer 2.0</title> 
<link href="http://code.google.com/apis/maps/documentation/javascript/examples/standard.css" rel="stylesheet" type="text/css" />
<link href='http://fonts.googleapis.com/css?family=Gruppo' rel='stylesheet' type='text/css'>
<style>
#bg {
    font-family: 'Gruppo', serif;
    font-size: 26px;
    font-style: normal;
    font-weight: 400;
    text-shadow: none;
    text-decoration: none;
    text-transform: none;
    letter-spacing: 0em;
    word-spacing: 0em;
    color: grey;
    line-height: 1.2;
}
#button {
    position:fixed;
    top:31px;
}
#clearMapButton {
    position:fixed;
    top:31px;
    left:400px;
}

</style>
<script src="http://maps.google.com/maps/api/js?sensor=false"></script>
<script src="http://maps.google.com/maps/api/js?libraries=geometry&sensor=false"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.4.4/jquery.min.js"></script> 
</head> 
<body style="font: 75% Lucida Grande, Trebuchet MS"> 
<div id='bg'>BioGeomancer2.0</div>
<input id="location" type="search" style="width: 300px;"> 
<input id="button" type="button" value="Georeference">
<input id="clearMapButton" type="button" value="Clear Map">
<div id="map_canvas" style="height:90%; width:100%;"></div>
<script>

/**
 * The app object.
 */
var app = app || {};

/**
 * Gets extent from bounds. If bounds is null, null is returned. Otherwise
 * the geodesic in meters (the "extent") between the center of the bounds
 * and the southwest corner is returned.
 *
 * @param bounds google.maps.LatLngBounds
 */
app.getExtent = function(bounds) {
    if (bounds == null) {
        return 0;
    }
    var center = bounds.getCenter(),
    sw = bounds.getSouthWest(),
    extent = google.maps.geometry.spherical.computeDistanceBetween(center, sw);
    return extent;
}

/**
 * Gets the center of a Google geocode result given bounds. If bounds is null
 * the location is returned. Otherwise the bounds center is returned.
 */
app.getCenter = function(bounds, location) {
    if (bounds == null) {
        return location;
    }
    return bounds.getCenter();
}

/**
 * Displays Google geocoder web service results as markers on the map. Also
 * uses the geocalc web service to asynchronously calculate uncertainties
 * which are rendered as circles on the map around their corresponding marker.
 */
app.displayResults = function(results) {
    if (results.length == 0) {
        return;
    }
    var viewport = null,
    bounds = null,
    center = null,
    extent = null,
    marker = null,
    infowin = null,
    r = null,
    viewport = results[0].geometry.viewport;
    for (x in results) {
        r = results[x];
        bounds = r.geometry.bounds;
        center = app.getCenter(bounds, r.geometry.location);
        marker = new google.maps.Marker({
            position: center,
            title: r.formatted_address
        });
        extent = app.getExtent(bounds);
        url = app.getGeoCalcUrl(center, extent);
        app.geocoderMarkers.push(marker);
        cb = app.radiusCallback(marker, r, extent, url);
        app.displayRadius(bounds, center, x, cb);            
        viewport.union(r.geometry.viewport);
    }
    app.map.fitBounds(viewport);
}

app.radiusCallback = function(marker, r, extent, url, x) {
    return function(radius) {
        marker.setMap(app.map);
        google.maps.event.addListener(marker, 'click', app.markerClickHandler(marker, r, extent, url, x, radius));            
    }
}

app.markerClickHandler = function(marker, r, extent, url, x, radius) {
    return function() {
        var content = '<div id="content">' +
            '<h3>' + r.formatted_address + '</h3>' +
            'Point: ' + marker.getPosition().lat() + ', ' + marker.getPosition().lng() +
            '<br>Radius: ' + radius + 
            '<br><a target="_blank" href="' + url + '">Full GeoCalc URL</a>' +
            '<br><a href="javascript::" class="zoom">zoom here</a>' +
            '</div>';
        var e = document.createElement('div');
        e.innerHTML = content;
        e.getElementsByClassName('zoom')[0].addEventListener('click', function() {
            app.map.setZoom(12);
            app.map.panTo(marker.getPosition());
            }, false);
        
        var infowin = new google.maps.InfoWindow({
            content: e
        });
        infowin.setPosition(marker.getPosition());
        infowin.open(app.map, marker);
    }
}

/**
 * AJAX call to geocalc service. Renders a circle on success. Adds circle
 * to app.geocoderMarkers.
 *
 */
app.displayRadius = function(bounds, center, x, cb) {
    extent = app.getExtent(bounds);
    url = app.getGeoCalcUrl(center, extent);
    jQuery.ajax({
        url: url,
        success: function(data) {
            var point = new google.maps.LatLng(data.point.latitude, data.point.longitude),
            circle = new google.maps.Circle({
                map : app.map,
                center : point,
                radius : data.radius,
                fillColor: '#CEE3F6',
                strokeWeight: 1
            });
            app.geocoderMarkers.push(circle);
            cb(data.radius);
            //var e = document.getElementById('radius-' + x);
            //e.innerText = '' + data.radius;
        }
    });
}

app.GEO_CALC_URL = '/geocalc?type=pno&extent=EXTENT&ll=LAT,LNG&sys=dms&datum=not_recorded&source=gazetteer';

/**
 * Gets the geocalc web service URL for the given center point and bounding
 * box extent from a Google geocode result.
 */
app.getGeoCalcUrl = function(center, extent) {
    var url = app.GEO_CALC_URL;
    url = url.replace('EXTENT', String(extent));
    url = url.replace('LAT', String(center.lat()));
    url = url.replace('LNG', String(center.lng()));
    return url;
}

/**
 * Handler for the georeference button. Geocodes the address using Google
 * geocoder web service. On success it displays results as markers and
 * uncertainties as circles on the map. Adds a history token for the query.
 */
app.handleOnClick = function(evt) {
    var location = $('location').value;
    if (location == '') {
        location = $('location').getAttribute('placeholder');
    }    
    // Adds a history token and eventually georeferences:
    app.go(location);
}

/**
 * Cache for georeference results. Key is the location, results are the Google
 * geocoder results.
 */
app.cache = {};

/**
 * Success handler for the Google geocoder. 
 */
app.onSuccess = function(results) {
    app.clearOverlays();
    app.displayResults(results);
}

/**
 * Georeferences a location if not in the cache.
 */
app.georeference = function(location) {
	if (app.cache[location] != null) {
		app.onSuccess(app.cache[location]);
		return;
	}
    app.geocoder.geocode({'address': location}, function(results, status) {     
        if (status == google.maps.GeocoderStatus.OK) {
            app.cache[location] = results;
            app.clearOverlays();
            app.displayResults(results);
        } else {
            alert(status);
            app.handleClearMap();
            $('button').focus();
        }        
    });	
}

/**
 * Clears overlays from the map and resets json_results and location.
 */
app.handleClearMap = function(evt) {
    app.clearOverlays();
    $('json_results').innerHTML = '';
    $('location').value = '';
}

/**
 * Clears overlays from the map.
 */
app.clearOverlays = function() {
    if (app.geocoderMarkers) {
        for (i in app.geocoderMarkers) {
            app.geocoderMarkers[i].setMap(null);
        }
        app.geocoderMarkers.length = 0;
    }
}

/**
 * Goes to the page with results for q which is a location query and pushes a 
 * new history token.
 */
app.go = function(q) {
    app.setupPage(q);
    history.pushState(q, document.title, '?q=' + q);
}

/**
 * Handler for browser history events.
 */
onpopstate = function(event) {
    app.setupPage(event.state);
}


/**
 * Sets up the page based on the query history token. 
 */
app.setupPage = function(query) {
    if (query == null) {
        // Handles intitial page load with or without q param:
        var q = app.urlParams['q'];
        if (q == null) {
            app.handleClearMap();
            return;
        }
        $('location').value = q;
        app.georeference(q);
    } else {
    	$('location').value = query;  
    	app.georeference(query);
    }
  }

app.urlParams = {}

/**
 * Immediate function setup.
 */
$ = (function () {
    var $ = function(id) {
            return document.getElementById(id);
        },
        e,
        a = /\+/g,  // Regex for replacing addition symbol with a space
        r = /([^&=]+)=?([^&]*)/g,
        d = function (s) { return decodeURIComponent(s.replace(a, " ")); },
        q = window.location.search.substring(1);

    // Parses URL parameters:
    while (e = r.exec(q)) {
        app.urlParams[d(e[1])] = d(e[2]);
    }
    
    var queryPlaceholder = "Berkeley, CA",
    latlng = new google.maps.LatLng(37.8, -121);
    app.mapOptions = {
        mapTypeId: google.maps.MapTypeId.TERRAIN
    };
    app.geocoder = new google.maps.Geocoder();
    app.map = new google.maps.Map(document.getElementById("map_canvas"), app.mapOptions);
    app.geocoderMarkers = [];
    $('button').addEventListener('click', app.handleOnClick, false);
    $('clearMapButton').addEventListener('click', app.handleClearMap, false);
    $('location').setAttribute('placeholder', queryPlaceholder);
    $('location').addEventListener('keyup', function(evt) {
        // Programatically clicks if keyup is the enter key:
        if (evt.keyCode === 13) {
            $('button').click();
        }
    }, false);
    return $;
}());
</script> 
</body> 
</html> 